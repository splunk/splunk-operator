apiVersion: appframework.splunk.com/v1
kind: AppFrameworkRepository
metadata:
  name: s3-app-repo
  namespace: splunk-operator
spec:
  storageType: s3
  provider: aws
  endpoint: https://s3-us-west-2.amazonaws.com
  region: us-west-2
  secretRef: s3-credentials
  path: splunk-apps/
  pollInterval: 300s
  retryPolicy:
    maxRetries: 3
    backoffMultiplier: 2
    initialInterval: 30s
    maxInterval: 300s
  deletionPolicy:
    enabled: true
    strategy: graceful
    gracePeriod: 300s
    safeguards:
      protectedApps:
        - "splunk_app_aws"
        - "enterprise_security"
        - "splunk_*"  # Protect all Splunk built-in apps
      bulkDeletionThreshold: 5
      backupBeforeDeletion: true
      approvalWorkflow:
        required: false
        approvers:
          - "admin@company.com"
          - "splunk-ops-team"
        timeout: 24h
    retentionPolicy:
      keepDeletedApps: true
      retentionDuration: 72h
      backupLocation: "s3://app-backups/"
      compressBackups: true
      cleanupSchedule:
        enabled: true
        schedule: "0 2 * * *"  # Daily at 2 AM
    notifications:
      webhook: "https://alerts.company.com/app-deletions"
      slack: "#splunk-ops"
      email:
        - "splunk-admin@company.com"
      events:
        - "DeletionScheduled"
        - "DeletionCompleted"
        - "DeletionFailed"
  tls:
    enabled: true
    insecureSkipVerify: false
