---
# ================= Canonical TLS under $SPLUNK_HOME =================
- name: "Ensure canonical TLS dir"
  file:
    path: "[[ .CanonicalDir ]]"
    state: directory
    owner: splunk
    group: splunk
    mode: "0755"

# Probe mounted inputs
- name: "Stat source files under SrcDir"
  block:
    - name: "Stat tls.crt"
      stat:
        path: "[[ .SrcDir ]]/tls.crt"
      register: s_tls_crt

    - name: "Stat tls.key"
      stat:
        path: "[[ .SrcDir ]]/tls.key"
      register: s_tls_key

    - name: "Stat ca.crt"
      stat:
        path: "[[ .SrcDir ]]/ca.crt"
      register: s_ca_crt

# Fail early if key/cert missing
- name: "Validate required source files are present"
  assert:
    that:
      - s_tls_crt.stat.exists
      - s_tls_key.stat.exists
    fail_msg: "TLS inputs not found at [[ .SrcDir ]]. Mount Secret/CSI with tls.crt and tls.key."
    success_msg: "Found tls.crt and tls.key at [[ .SrcDir ]]"

# Copy into canonical paths (explicit target filenames)
- name: "Copy tls.crt -> [[ .TLSCrt ]]"
  copy:
    src: "[[ .SrcDir ]]/tls.crt"
    dest: "[[ .TLSCrt ]]"
    owner: splunk
    group: splunk
    mode: "0644"
    remote_src: true
  when: s_tls_crt.stat.exists

- name: "Copy tls.key -> [[ .TLSKey ]] (0600)"
  copy:
    src: "[[ .SrcDir ]]/tls.key"
    dest: "[[ .TLSKey ]]"
    owner: splunk
    group: splunk
    mode: "0600"
    remote_src: true
  when: s_tls_key.stat.exists

- name: "Copy ca.crt -> [[ .CACrt ]] (if present)"
  copy:
    src: "[[ .SrcDir ]]/ca.crt"
    dest: "[[ .CACrt ]]"
    owner: splunk
    group: splunk
    mode: "0644"
    remote_src: true
  when: s_ca_crt.stat.exists

# ================= Optional trust bundle (from separate Secret) =================
- name: "Optional trust bundle from [[ .TrustDir ]]/[[ .TrustKey ]] -> [[ .CABundle ]]"
  block:
    - name: "Stat trust bundle source"
      stat:
        path: "[[ .TrustDir ]]/[[ .TrustKey ]]"
      register: s_bundle

    - name: "Copy provided trust bundle"
      copy:
        src: "[[ .TrustDir ]]/[[ .TrustKey ]]"
        dest: "[[ .CABundle ]]"
        owner: splunk
        group: splunk
        mode: "0644"
        remote_src: true
      when: s_bundle.stat.exists

# ================= Build custom trust store (customer behavior) =================
- name: "Detect OS CA bundle path"
  shell: |
    for f in \
      /etc/pki/tls/certs/ca-bundle.crt \
      /etc/ssl/certs/ca-certificates.crt \
      /etc/ssl/ca-bundle.pem \
      /etc/ssl/cert.pem
    do
      [ -r "$f" ] && { echo "$f"; exit 0; }
    done
    exit 1
  register: _os_ca
  changed_when: false
  failed_when: false

- name: "Build trust bundle at [[ .CABundle ]] (CA + OS bundle if present)"
  shell: |
    set -e
    dst="[[ .CABundle ]]"
    ca="[[ .CACrt ]]"
    os="{{ _os_ca.stdout | default('') }}"
    tmp="$(mktemp)"
    if [ -s "$ca" ] && [ -n "$os" ] && [ -s "$os" ]; then
      cat "$ca" "$os" > "$tmp"
    elif [ -s "$ca" ]; then
      cat "$ca" > "$tmp"
    elif [ -n "$os" ] && [ -s "$os" ]; then
      cat "$os" > "$tmp"
    else
      # nothing to build
      exit 0
    fi
    install -o splunk -g splunk -m 0644 -T "$tmp" "$dst"
    rm -f "$tmp"
  when: not (s_bundle.stat.exists | default(false))

# ================= Split tls.crt into S-* (leaf + chain) =================
- name: "Split [[ .TLSCrt ]] into S-* (leaf + chain)"
  shell: |
    set -e
    cd "[[ .CanonicalDir ]]"
    rm -f S-* || true
    awk 'BEGIN{n=-1}
         /-----BEGIN CERTIFICATE-----/{n++; file=sprintf("S-%02d",n)}
         {if(n>=0) print > file}
         /-----END CERTIFICATE-----/{close(file)}' "[[ .TLSCrt ]]"
    test -s S-00
  changed_when: true

# ================= Generate password (prefer Splunk OpenSSL; fallback safe) =================
- name: "Generate kv/tls key password"
  no_log: true
  shell: |
    set -e
    if LD_LIBRARY_PATH=/opt/splunk/lib OPENSSL_FIPS="${SPLUNK_FIPS:-}" /opt/splunk/bin/openssl version >/dev/null 2>&1; then
      if LD_LIBRARY_PATH=/opt/splunk/lib OPENSSL_FIPS="${SPLUNK_FIPS:-}" /opt/splunk/bin/openssl rand -base64 24 >/dev/null 2>&1; then
        LD_LIBRARY_PATH=/opt/splunk/lib OPENSSL_FIPS="${SPLUNK_FIPS:-}" /opt/splunk/bin/openssl rand -base64 24
      else
        dd if=/dev/urandom bs=24 count=1 2>/dev/null | base64
      fi
    elif command -v openssl >/dev/null 2>&1; then
      openssl rand -base64 24
    else
      dd if=/dev/urandom bs=24 count=1 2>/dev/null | base64
    fi
  register: tls_key_password

# If a fixed password file is provided, prefer it
- name: "Override password from [[ .KVPasswordFile ]] if present"
  no_log: true
  set_fact:
    kv_clear_pass: "{{ lookup('file', '[[ .KVPasswordFile ]]') | trim }}"
  when: '("[[ .KVPasswordFile ]]" | length) > 0'
  ignore_errors: true

- name: "Set kv_clear_pass final"
  no_log: true
  set_fact:
    kv_clear_pass: "{{ kv_clear_pass | default(tls_key_password.stdout) }}"

# ================= Encrypt key and build bundles =================
- name: "Encrypt private key -> tls_enc.key"
  no_log: true
  shell: |
    set -e
    LD_LIBRARY_PATH=/opt/splunk/lib OPENSSL_FIPS="${SPLUNK_FIPS:-}" \
      /opt/splunk/bin/openssl rsa -aes256 \
      -passout pass:"{{ kv_clear_pass }}" \
      -in "[[ .TLSKey ]]" \
      -out "[[ .CanonicalDir ]]/tls_enc.key"
    chown splunk:splunk "[[ .CanonicalDir ]]/tls_enc.key"
    chmod 0600 "[[ .CanonicalDir ]]/tls_enc.key"

- name: "Build KVBUNDLE at [[ .KVBundlePath ]] (enc key + full chain + CA if any)"
  shell: |
    set -e
    cd "[[ .CanonicalDir ]]"
    CHAIN_FILES=""
    for f in S-*; do
      [ -s "$f" ] && CHAIN_FILES="$CHAIN_FILES $f"
    done
    if [ -s "[[ .CACrt ]]" ]; then
      cat tls_enc.key $CHAIN_FILES "[[ .CACrt ]]" > "[[ .KVBundlePath ]]"
    else
      cat tls_enc.key $CHAIN_FILES > "[[ .KVBundlePath ]]"
    fi
    chown splunk:splunk "[[ .KVBundlePath ]]"
    chmod 0600 "[[ .KVBundlePath ]]"
    rm -f S-*

# Optional aliases for KVBUNDLE (customer names)
- name: "Set KVBUNDLE alias paths"
  set_fact:
    _alias_crt: "[[ .KVBundleAliasCRT ]]"
    _alias_pem: "[[ .KVBundleAliasPEM ]]"

- name: "Alias to CRT path"
  file:
    src:  "[[ .KVBundlePath ]]"
    dest: "{{ _alias_crt }}"
    state: link
    owner: splunk
    group: splunk
    force: yes
  when: _alias_crt | length > 0

- name: "Alias to PEM path"
  file:
    src:  "[[ .KVBundlePath ]]"
    dest: "{{ _alias_pem }}"
    state: link
    owner: splunk
    group: splunk
    force: yes
  when: _alias_pem | length > 0

# Pick the cert path your downstream roles expect (prefer customer-style alias)
- name: "Choose kv bundle cert path for facts"
  set_fact:
    kv_bundle_cert_path: >-
      {{ _alias_crt if (_alias_crt | default('') | length > 0) else '[[ .KVBundlePath ]]' }}

# ===================== FACTS ONLY (no direct conf writes) =====================
- name: "Build splunk_ssl_password fact"
  no_log: true
  set_fact:
    splunk_ssl_password:
      ssl:
        password: "{{ kv_clear_pass }}"
        ca: "[[ .CACrt ]]"
        cert: "{{ kv_bundle_cert_path }}"
        enable: true
      conf:
        - key: "server"
          value:
            directory: "[[ .SplunkHome ]]/etc/system/local"
            content:
              kvstore:
                serverCert: "{{ kv_bundle_cert_path }}"
                sslPassword: "{{ kv_clear_pass }}"
                sslVerifyServerName: true
                sslVerifyServerCert: true
              sslConfig:
                sslVersions: "tls1.2"
                sslVersionsForClient: "tls1.2"
                requireClientCert: false
                sslVerifyServerName: true
                cliVerifyServerName: true
                sslVerifyServerCert: true
                caTrustStore: "splunk,OS"
                caTrustStorePath: "[[ .CABundle ]]"
              node_auth:
                signatureVersion: "v2"

- name: "Merge splunk_ssl_password into splunk"
  no_log: true
  set_fact:
    splunk: "{{ (splunk | default({})) | combine(splunk_ssl_password, recursive=true, list_merge='append_rp') }}"

# ================= Final safety: assert canonical perms =================
- name: "Re-assert perms ([[ .TLSKey ]])"
  file:
    path: "[[ .TLSKey ]]"
    owner: splunk
    group: splunk
    mode: "0600"

- name: "Re-assert perms ([[ .TLSCrt ]])"
  file:
    path: "[[ .TLSCrt ]]"
    owner: splunk
    group: splunk
    mode: "0644"

- name: "Re-assert perms ([[ .CACrt ]])"
  file:
    path: "[[ .CACrt ]]"
    owner: splunk
    group: splunk
    mode: "0644"
  when: s_ca_crt.stat.exists
