name: 'Reusable Integration Test'

on:
  workflow_call:
    inputs:
      cluster-platform:
        description: 'Cloud platform: eks, azure, or gcp'
        required: true
        type: string
      test-focus:
        description: 'Test focus pattern'
        required: true
        type: string
      cluster-name:
        description: 'Cluster name'
        required: true
        type: string
      cluster-workers:
        description: 'Number of worker nodes'
        required: false
        type: number
        default: 3
      cluster-nodes:
        description: 'Number of control plane nodes'
        required: false
        type: number
        default: 1
      splunk-operator-image:
        description: 'Splunk operator image to test (if empty, will be constructed from ECR_REPOSITORY)'
        required: false
        type: string
        default: ''
      splunk-enterprise-image:
        description: 'Splunk enterprise image to test (if empty, will use secret)'
        required: false
        type: string
        default: ''
      use-release-enterprise-image:
        description: 'Use release enterprise image from env file'
        required: false
        type: boolean
        default: false
      release-enterprise-image:
        description: 'Release enterprise image name from env file'
        required: false
        type: string
        default: ''
      cluster-wide:
        description: 'Deploy operator cluster-wide'
        required: false
        type: boolean
        default: true
      deployment-type:
        description: 'Deployment type (empty, helm, etc.)'
        required: false
        type: string
        default: ''
    secrets:
      AWS_ACCESS_KEY_ID:
        required: false
      AWS_SECRET_ACCESS_KEY:
        required: false
      AWS_DEFAULT_REGION:
        required: false
      AZURE_CREDENTIALS:
        required: false
      GCP_SERVICE_ACCOUNT_KEY:
        required: false
      ECR_REPOSITORY:
        required: false
      SPLUNK_ENTERPRISE_IMAGE:
        required: false
      TEST_BUCKET:
        required: false
      TEST_INDEXES_S3_BUCKET:
        required: false
      EKS_VPC_PRIVATE_SUBNET_STRING:
        required: false
      EKS_VPC_PUBLIC_SUBNET_STRING:
        required: false
      EKS_SSH_PUBLIC_KEY:
        required: false

jobs:
  integration-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CLUSTER_NODES: ${{ inputs.cluster-nodes }}
      CLUSTER_WORKERS: ${{ inputs.cluster-workers }}
      TEST_FOCUS: ${{ inputs.test-focus }}
      TEST_CLUSTER_PLATFORM: ${{ inputs.cluster-platform }}
      TEST_CLUSTER_NAME: ${{ inputs.cluster-name }}
      ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
      ECR_REGISTRY: ${{ secrets.ECR_REPOSITORY }}
      TEST_BUCKET: ${{ secrets.TEST_BUCKET }}
      TEST_INDEXES_S3_BUCKET: ${{ secrets.TEST_INDEXES_S3_BUCKET }}
      CLUSTER_WIDE: ${{ inputs.cluster-wide }}
      DEPLOYMENT_TYPE: ${{ inputs.deployment-type }}
      # SPLUNK_ENTERPRISE_IMAGE and SPLUNK_OPERATOR_IMAGE are set dynamically in "Set Image Names" step

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Image Names
        id: set-images
        run: |
          echo "=== Setting Image Names ==="

          # Set operator image (construct if empty)
          if [ -z "${{ inputs.splunk-operator-image }}" ]; then
            OPERATOR_IMAGE="${{ secrets.ECR_REPOSITORY }}/splunk/splunk-operator:${{ github.sha }}"
            echo "SPLUNK_OPERATOR_IMAGE=${OPERATOR_IMAGE}" >> $GITHUB_ENV
            echo "✓ Constructed operator image: ${OPERATOR_IMAGE}"
          else
            echo "SPLUNK_OPERATOR_IMAGE=${{ inputs.splunk-operator-image }}" >> $GITHUB_ENV
            echo "✓ Using provided operator image: ${{ inputs.splunk-operator-image }}"
          fi

          # Set enterprise image (use release or secret based on input)
          if [ -z "${{ inputs.splunk-enterprise-image }}" ]; then
            if [ "${{ inputs.use-release-enterprise-image }}" == "true" ]; then
              ENTERPRISE_IMAGE="${{ inputs.release-enterprise-image }}"
              echo "✓ Using release enterprise image: ${ENTERPRISE_IMAGE}"
            else
              ENTERPRISE_IMAGE="${{ secrets.SPLUNK_ENTERPRISE_IMAGE }}"
              echo "✓ Using secret enterprise image (from SPLUNK_ENTERPRISE_IMAGE secret)"
            fi

            if [ -z "${ENTERPRISE_IMAGE}" ]; then
              echo "❌ ERROR: Enterprise image is empty!"
              echo "   - use-release-enterprise-image: ${{ inputs.use-release-enterprise-image }}"
              echo "   - release-enterprise-image: ${{ inputs.release-enterprise-image }}"
              echo "   - SPLUNK_ENTERPRISE_IMAGE secret is not set or empty"
              exit 1
            fi

            echo "SPLUNK_ENTERPRISE_IMAGE=${ENTERPRISE_IMAGE}" >> $GITHUB_ENV
          else
            echo "SPLUNK_ENTERPRISE_IMAGE=${{ inputs.splunk-enterprise-image }}" >> $GITHUB_ENV
            echo "✓ Using provided enterprise image: ${{ inputs.splunk-enterprise-image }}"
          fi

          echo "=== Image Names Set Successfully ==="

      - name: Load environment variables
        id: dotenv
        uses: falti/dotenv-action@d4d12eaa0e1dd06d5bdc3d7af3bf4c8c93cb5359

      - name: Setup Operator Tools
        uses: ./.github/actions/setup-operator-tools
        with:
          operator-sdk-version: ${{ steps.dotenv.outputs.OPERATOR_SDK_VERSION }}
          go-version: ${{ steps.dotenv.outputs.GO_VERSION }}

      - name: Setup Kubernetes Tools
        uses: ./.github/actions/setup-k8s-tools
        with:
          kubectl-version: ${{ steps.dotenv.outputs.KUBECTL_VERSION }}
          helm-version: v3.8.2
          eksctl-version: ${{ steps.dotenv.outputs.EKSCTL_VERSION }}

      - name: Setup Cloud Authentication
        uses: ./.github/actions/configure-cloud-auth
        with:
          cloud-provider: ${{ inputs.cluster-platform == 'eks' && 'aws' || inputs.cluster-platform == 'azure' && 'azure' || 'gcp' }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}
          azure-credentials: ${{ secrets.AZURE_CREDENTIALS }}
          gcp-service-account-key: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Create Cluster
        run: |
          export EKS_CLUSTER_K8_VERSION=${{ steps.dotenv.outputs.EKS_CLUSTER_K8_VERSION }}
          make cluster-up

      - name: Install Kubernetes Add-ons
        uses: ./.github/actions/setup-k8s-tools
        with:
          kubectl-version: ${{ steps.dotenv.outputs.KUBECTL_VERSION }}
          install-metrics-server: 'true'

      - name: Run Integration Tests
        id: test
        run: |
          make int-test

      - name: Collect Test Artifacts
        if: always()
        uses: ./.github/actions/collect-test-artifacts
        with:
          artifact-name: test-logs-${{ inputs.cluster-platform }}-${{ inputs.test-focus }}

      - name: Cleanup Test Artifacts
        if: always()
        run: |
          make cleanup
          make clean

      - name: Cleanup Cluster
        if: always()
        run: |
          make cluster-down
