{{- if or .Values.customResources.searchHeadCluster.enabled .Values.sva.c3.enabled .Values.sva.m4.enabled }}
apiVersion: v1
kind: List
items:
{{- range default (default (until 1) .Values.sva.c3.searchHeadClusters) .Values.sva.m4.searchHeadClusters }}
- apiVersion:  enterprise.splunk.com/v4
  kind: SearchHeadCluster
  metadata:
  {{- if or $.Values.sva.c3.enabled $.Values.sva.m4.enabled }}
    name: {{ .name }}
  {{- else if $.Values.customResources.searchHeadCluster.enabled }}
    name: {{ $.Values.customResources.searchHeadCluster.name }}
  {{- end }}
    namespace: {{ default $.Release.Namespace $.Values.customResources.searchHeadCluster.namespaceOverride }}
  {{- with $.Values.customResources.searchHeadCluster.additionalLabels }}
    labels:
{{ toYaml . | indent 6 }}
  {{- end }}
  {{- with $.Values.customResources.searchHeadCluster.additionalAnnotations }}
    annotations:
{{ toYaml . | indent 6 }}
  {{- end }}
  spec:
  {{- if $.Values.customResources.searchHeadCluster.replicaCount }}
    replicas: {{ $.Values.customResources.searchHeadCluster.replicaCount }}
  {{- end }}
  {{- with $.Values.customResources.searchHeadCluster.appRepo }}
    appRepo: 
{{ toYaml . | indent 6 }}
  {{- end }}
  {{- if $.Values.existingClusterManager }}
    clusterManagerRef:
      name: {{ $.Values.existingClusterManager.name }}
    {{- if $.Values.existingClusterManager.namespace }}
      namespace: {{ $.Values.existingClusterManager.namespace }}
    {{- end }}
  {{- else if or $.Values.customResources.clusterManager.enabled $.Values.sva.c3.enabled $.Values.sva.m4.enabled }}
    clusterManagerRef:
      name: {{ $.Values.customResources.clusterManager.name }}
    {{- if $.Values.customResources.clusterManager.namespaceOverride }}
      namespace: {{ $.Values.customResources.clusterManager.namespaceOverride }}
    {{- end }}
  {{- end }}
  {{- if $.Values.existingLicenseManager }}
    licenseManagerRef:
      name: {{ $.Values.existingLicenseManager.name }}
    {{- if $.Values.existingLicenseManager.namespace }}
      namespace: {{ $.Values.existingLicenseManager.namespace }}
    {{- end }}
  {{- else if or $.Values.customResources.licenseManager.enabled }}
    licenseManagerRef:
      name: {{ $.Values.customResources.licenseManager.name }}
    {{- if $.Values.customResources.licenseManager.namespaceOverride }}
      namespace: {{ $.Values.customResources.licenseManager.namespaceOverride }}
    {{- end }}
  {{- end }}
  {{- if $.Values.existingMonitoringConsole }}
    monitoringConsoleRef:
      name: {{ $.Values.existingMonitoringConsole.name }}
    {{- if $.Values.existingMonitoringConsole.namespace }}
      namespace: {{ $.Values.existingMonitoringConsole.namespace }}
    {{- end }}
  {{- else if $.Values.customResources.monitoringConsole.enabled }}
    monitoringConsoleRef:
      name: {{ $.Values.customResources.monitoringConsole.name }}
    {{- if $.Values.customResources.monitoringConsole.namespaceOverride }}
      namespace: {{ $.Values.customResources.monitoringConsole.namespaceOverride }}
    {{- end }}
  {{- end }}
  {{- if $.Values.image.repository }}
    image: {{ $.Values.image.repository }}
  {{- end }}
  {{- if $.Values.image.imagePullPolicy }}
    imagePullPolicy: {{ $.Values.image.imagePullPolicy }}
  {{- end }}
  {{- with $.Values.image.imagePullSecrets }}
    imagePullSecrets:
{{ toYaml . | indent 6 }}
  {{- end }}
  {{- with $.Values.customResources.searchHeadCluster.volumes }}
    volumes:
{{ toYaml . | indent 6 }}
  {{- end }}
  {{- if $.Values.customResources.searchHeadCluster.licenseUrl }}
    licenseUrl: {{ $.Values.customResources.searchHeadCluster.licenseUrl }}
  {{- end }}
  {{- if $.Values.customResources.searchHeadCluster.defaultsUrl }}
    defaultsUrl: {{ $.Values.customResources.searchHeadCluster.defaultsUrl }}
  {{- end }}
  {{- if $.Values.sva.m4.enabled }}
    {{- $cm_name := $.Values.customResources.clusterManager.name -}}
    {{- if and $.Values.existingClusterManager $.Values.existingClusterManager.name }}
      {{- $cm_name = $.Values.existingClusterManager.name -}}
    {{- end }}
    defaults: |-
      splunk:
        multisite_master: splunk-{{ $cm_name }}-cluster-manager-service
        site: {{ .site }}
  {{- else if $.Values.customResources.searchHeadCluster.defaults }}
    defaults: |-
{{ toYaml $.Values.customResources.searchHeadCluster.defaults | indent 6 }}
  {{- end }}
  {{- if $.Values.customResources.searchHeadCluster.defaultsUrlApps }}
    defaultsUrlApps: {{ $.Values.customResources.searchHeadCluster.defaultsUrlApps }}
  {{- end }}
  {{- with $.Values.customResources.searchHeadCluster.extraEnv }}
    extraEnv:
{{ toYaml . | indent 6 }}
  {{- end }}
  {{- if $.Values.customResources.searchHeadCluster.livenessInitialDelaySeconds }}
    livenessInitialDelaySeconds: {{ $.Values.customResources.searchHeadCluster.livenessInitialDelaySeconds }}
  {{- end }}
  {{- if $.Values.customResources.searchHeadCluster.readinessInitialDelaySeconds }}
    readinessInitialDelaySeconds: {{ $.Values.customResources.searchHeadCluster.readinessInitialDelaySeconds }}
  {{- end }}
  {{- if $.Values.customResources.searchHeadCluster.startupProbe }}
    startupProbe:
{{ toYaml $.Values.customResources.searchHeadCluster.startupProbe | indent 6 }}
  {{- end }}
  {{- if $.Values.customResources.searchHeadCluster.livenessProbe }}
    livenessProbe:
{{ toYaml $.Values.customResources.searchHeadCluster.livenessProbe | indent 6 }}
  {{- end }}
  {{- if $.Values.customResources.searchHeadCluster.readinessProbe }}
    readinessProbe:
{{ toYaml $.Values.customResources.searchHeadCluster.readinessProbe | indent 6 }}
  {{- end }}
  {{- with $.Values.customResources.searchHeadCluster.etcVolumeStorageConfig }}
    etcVolumeStorageConfig:
{{ toYaml . | indent 6 }}
  {{- end }}
  {{- with $.Values.customResources.searchHeadCluster.varVolumeStorageConfig }}
    varVolumeStorageConfig:
{{ toYaml . | indent 6 }}
  {{- end }}
  {{- with $.Values.customResources.searchHeadCluster.resources }}
    resources:
{{ toYaml . | indent 6 }}
  {{- end }}
  {{- if $.Values.customResources.searchHeadCluster.serviceAccount }}
    serviceAccount: {{ $.Values.customResources.searchHeadCluster.serviceAccount }}
  {{- end }}
  {{- with $.Values.customResources.searchHeadCluster.serviceTemplate }}
    serviceTemplate:
{{ toYaml . | indent 6 }}
  {{- end }}
  {{- with $.Values.customResources.searchHeadCluster.tolerations }}
    tolerations:
{{ toYaml . | indent 6 }}
  {{- end }}
  {{- if $.Values.customResources.searchHeadCluster.topologySpreadConstraints }}
  {{- with $.Values.customResources.searchHeadCluster.topologySpreadConstraints }}
    topologySpreadConstraints:
{{ toYaml . | indent 6 }}
  {{- end }}
  {{- end }}
  {{- if  and ($.Values.sva.m4.enabled)  (.zone) }}
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
          - matchExpressions:
            - key: topology.kubernetes.io/zone
              operator: In
              values:
              - {{ .zone }}
  {{- else }}
    {{- with $.Values.customResources.searchHeadCluster.affinity }}
    affinity:
{{ toYaml . | indent 6 }}
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}
